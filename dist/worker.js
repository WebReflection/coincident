const{ArrayBuffer:e,Atomics:t,Promise:s}=globalThis,{isArray:r}=Array,{create:n,getPrototypeOf:a,values:o}=Object,c=a(Int32Array),i=n(t),l=({currentTarget:e,type:t,origin:s,lastEventId:r,source:n,ports:a},o)=>e.dispatchEvent(new MessageEvent(t,{data:o,origin:s,lastEventId:r,source:n,ports:a})),p=()=>s.withResolvers();let f=0;const u=new Map,d=(e,t)=>class extends e{constructor(e,...s){super(e,...s),e instanceof t&&u.set(this,[f++,0,p()])}},w=new WeakSet,y=e=>(w.add(e),e),g=(e,t)=>{const{data:s}=e,n=r(s)&&(s.at(0)===t||0===s.at(1)&&!t);return n&&(e.stopImmediatePropagation(),e.preventDefault()),n},h=e=>null!==e&&"object"==typeof e&&!w.has(e),v=new WeakMap,m=(t,s,r)=>{if(u.has(t))s.set(t,u.get(t)[0]);else if(!(t instanceof c||t instanceof e))for(const e of o(t))h(e)&&!r.has(e)&&(r.add(e),m(e,s,r))},E=(...e)=>({value:new s((t=>{let s=new Worker("data:application/javascript,onmessage%3De%3D%3EpostMessage(!Atomics.wait(...e.data))");s.onmessage=()=>t("ok"),s.postMessage(e)}))}),A=(e,t)=>{const s=u.get(e),[r,n,{promise:a}]=s;return s[1]=t,[r,a]};let{BigInt64Array:T,Int32Array:k,SharedArrayBuffer:b,addEventListener:M,postMessage:x}=globalThis,I=!0,S=e=>e,P=!1;const $=p();try{new b(4),i.waitAsync||(i.waitAsync=E),$.resolve()}catch(t){const s=x,r=M,n=[];let a="",o="";b=class extends e{},T=d(T,b),k=d(k,b),S=y,P=!0,i.notify=(e,t)=>{const[r]=(e=>v.get(e))(e);return s([a,1,e,r,t]),0},i.waitAsync=(...e)=>{const[t,s]=A(...e);return{value:s}},i.wait=(e,t,...s)=>{const[r]=A(e,t,...s),n=new XMLHttpRequest;n.responseType="json",n.open("POST",`${o}?sabayon`,!1),n.setRequestHeader("Content-Type","application/json"),n.send(`["${a}",${r},${t}]`);const{response:c}=n;u.delete(e);for(let t=0;t<c.length;t++)e[t]=c[t];return"ok"},r("message",(e=>{if(g(e,a)){const[t,s,...r]=e.data;switch(s){case 0:a=t,o=r.at(0)?.serviceWorker||"",o||(i.wait=null,$.resolve());break;case 1:((e,t,s)=>{for(const[r,[n,a,{resolve:o}]]of u)if(t===n&&s===a){for(let t=0;t<e.length;t++)r[t]=e[t];u.delete(r),o("ok");break}})(...r);break;case 2:((e,t,s)=>{for(const[s,r]of t)v.set(s,[r,e.currentTarget]);l(e,s)})(e,...r);break;case 3:$.resolve()}}else if(I){const{currentTarget:t,type:s,origin:r,lastEventId:a,source:o,ports:c}=e;n.push([{currentTarget:t,type:s,origin:r,lastEventId:a,source:o,ports:c},e.data])}})),M=(e,...t)=>{if(r(e,...t),n.length)for(const e of n.splice(0))l(...e)},x=(e,...t)=>s(((e,t)=>{const s=new Map;return h(t)&&m(t,s,new Set),s.size?[e,2,s,t]:t})(a,e),...t)}await $.promise,I=!1;const{BYTES_PER_ELEMENT:j}=Int32Array,{BYTES_PER_ELEMENT:B}=Uint16Array,{notify:R}=i,W=new TextDecoder("utf-16"),D=new WeakSet,L=(...e)=>(D.add(e),e);let O="";const U=new Map,_=(e,t,s)=>{const[r]=s,n=t.get(r);if(!n)throw new Error(`Unknown proxy.${r}()`);e(n,s)};let N=0;const q=([e,t,s,r,n,a,o,c,i,l],p)=>(...f)=>{let u=""!==O,d=0;u&&(d=((e,t)=>setTimeout(console.warn,1e3,`ðŸ’€ðŸ”’ - proxy.${e}() in proxy.${t}()`))(p,O));const w=N++,y=[];D.has(f.at(-1)||y)&&D.delete(y=f.pop());const g=r(i?f.map(i):f);let h=new t(new s(2*j));return c([e,2,p,w,h,g,n],{transfer:y}),l(h,0).value.then((()=>{u&&clearTimeout(d);const r=h[1];if(!r)return;const n=B*r;return h=new t(new s(n+n%j)),c([e,1,w,h]),l(h,0).value.then((()=>{const e=new Uint16Array(h.buffer),t=o?e.subarray(0,r):e.slice(0,r);return a(W.decode(t))}))}))},z=(e,t)=>new Proxy(t,{get:(t,s)=>t.get(s)||t.set(s,q(e,s)).get(s),set:(e,t,s)=>!!e.set(t,s)}),{wait:C,waitAsync:H}=i;var Y=({parse:e,stringify:t,transform:s,interrupt:r}=JSON)=>{const n=((e,t)=>async(s,[r,n,a,o,c])=>{c&&(O=r);try{const r=await s(...o);if(void 0!==r){const s=e(t?t(r):r);U.set(n,s),a[1]=s.length}}finally{c&&(O=""),a[0]=1,R(a,0)}})(t,s),a=p(),o=new Map;let c="",i=C;if(C&&r){const{handler:e,timeout:t=42}=r;i=(s,r,n)=>{for(;"timed-out"===(n=C(s,r,0,t));)e();return n}}return M("message",(t=>{if(g(t,c)){const[r,l,...p]=t.data;switch(l){case 0:c=r,a.resolve({polyfill:P,transfer:L,proxy:z([c,k,b,S,!!C,e,P,x,s,C?(...e)=>({value:{then:t=>t(i(...e))}}):H],o)});break;case 2:o.size?_(n,o,p):setTimeout(_,0,n,o,p);break;case 1:((e,t)=>{const s=U.get(e);U.delete(e);for(let e=new Uint16Array(t.buffer),r=0,{length:n}=s;r<n;r++)e[r]=s.charCodeAt(r);R(t,0)})(...p)}}})),a.promise};export{Y as default};
